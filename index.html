<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketing Facility Map</title>
    
    <style>
        /* Base Styles */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; 
            font-family: Arial, sans-serif; /* Changed from Inter */
            color: #333;
        }
        
        /* Map Container */
        #map {
            padding: 0;
            margin: 0;
            height: 100vh;
            width: 100vw;
            z-index: 0;
        }
        
        /* Filter Control Positioning */
        .top-left-control {
            position: absolute;
            top: 25px; 
            left: 10px;
            z-index: 10;
            width: 100px; 
            display: flex; 
            flex-direction: column; 
            margin-top: 5px;
        }

        /* General Button Styling */
        .btn {
            background-color: #f9fafb;
            padding: 0.5rem 0.5rem; /* px-2 py-1 */
            font-weight: 600; /* font-semibold */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow-md */
            transition: background-color 0.15s ease-in-out;
            width: 100%; /* w-full */
            font-size: 0.875rem; /* text-sm */
            cursor: pointer;
            margin-bottom: 0.25rem; /* mb-2 */
        }

        .btn-locate {
            background-color: #3b82f6; /* Blue 500 */
            color: #ffffff;
            border: none;
        }
        .btn-locate:hover {
            background-color: #2563eb; /* Blue 600 */
        }
        
        /* Filter Panel Styles */
        .filter-panel {
            position: absolute;
            top: 100%; 
            left: 0;
            width: 250px; 
            max-height: 70vh;
            overflow-y: auto;
            margin-top: 0.75rem; 
            
            padding: 0.75rem; /* p-3 */
            background-color: #ffffff;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05); /* shadow-xl */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            text-align: left;
        }

        .filter-controls {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            gap: 0.5rem; /* space-x-2 */
        }
        
        .filter-controls button {
            font-size: 0.75rem; /* text-xs */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            border-radius: 0.25rem; /* rounded */
            font-weight: 500; /* font-medium */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: background-color 0.15s ease-in-out;
            cursor: pointer;
            border: none;
        }
        
        #select-all-button {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-700 */
        }
        #select-all-button:hover {
            background-color: #a7f3d0; /* hover:bg-green-200 */
        }

        #clear-all-button {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-700 */
        }
        #clear-all-button:hover {
            background-color: #fecaca; /* hover:bg-red-200 */
        }

        .filter-panel h3 {
            font-weight: 600; /* font-semibold */
            color: #374151; /* gray-700 */
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        
        /* Checkbox list container */
        #filter-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.25rem; /* space-y-1 */
        }

        /* Checkbox label styling (the Symbol is inside this) */
        .filter-label {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* space-x-2 */
            cursor: pointer;
            padding: 0.25rem; /* p-1 */
            border-radius: 0.25rem; /* rounded */
            transition: background-color 0.15s ease-in-out;
            font-size: 0.875rem; /* text-sm */
        }
        .filter-label:hover {
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        
        .filter-label input[type="checkbox"] {
            border-radius: 0.25rem; /* rounded */
            color: #3b82f6; /* blue-500 */
            outline: none;
            border: 1px solid #d1d5db;
        }

        .filter-done-container {
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }

        .btn-done {
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            background-color: #3b82f6; /* blue-500 */
            color: #ffffff;
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.15s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow-md */
            border: none;
            cursor: pointer;
        }
        .btn-done:hover {
            background-color: #2563eb; /* hover:bg-blue-600 */
        }
        
        .hidden {
            display: none !important;
        }

        .map-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 9; /* Below the header and filter controls (z-index 10) */
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white */
            text-align: center;
            font-size: 0.75rem; /* text-xs */
            color: #4b5563; /* gray-600 */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(2px); /* Add a slight blur effect */
        }
        .map-footer a {
            color: #3b82f6; /* blue-500 */
            font-weight: 500;
            text-decoration: underline;
        }
    </style>
    
    <!-- Load Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

    <!-- Map Filter Control (Top Left) -->
    <div id="filter-control-container" class="top-left-control">
        <button id="home-button" class="btn">
            Home
        </button>

        <button id="locate-button" class="btn">
            Locate Me
        </button>

        <button id="filter-button" class="btn">
            Filter
        </button>
        
        <button id="export-csv-button" class="btn">
            Export
        </button>
        
        <!-- Filter Dropdown Panel (Initially Hidden) -->
        <div id="filter-panel" class="filter-panel hidden">
            <div class="filter-controls">
                <button id="clear-all-button">Clear All</button>
                <button id="select-all-button">Select All</button>
                <button id="done-button" class="btn-done">Done</button>
            </div>

            <h3>Filter by Facility Type:</h3>
            <div id="filter-checkboxes">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <div id="map">
    </div>

    <div id="map-footer" class="map-footer">
        <strong>Data Sources </strong> (last updated 10/04/2025): Indiana Department of Health: 
        <a href="https://www.in.gov/health" target="_blank" rel="noopener noreferrer">link;</a>
        Kentucky Cabinet for Health and Family Services: 
        <a href="https://www.chfs.ky.gov/agencies/os/oig/dhc/Pages/hcf.aspx" target="_blank" rel="noopener noreferrer">link;</a>
        US Centers For Medicare and Medicaid Services (CMS): 
        <a href="https://data.cms.gov/provider-data/" target="_blank" rel="noopener noreferrer">link;</a>
    </div>
    
    <script>
        // Global state variables
        let allData = [];
        let markerGroup = null;
        let currentFilteredData = [];
        let typeColors = {}; // Stores the mapping of event type to color

        // variable configuration
        const csvUrl = "https://raw.githubusercontent.com/wicket85/marketing_viewer/refs/heads/main/final_list_100_miles.csv";
        const LATITUDE_FIELD = 'lat';
        const LONGITUDE_FIELD = 'long';
        const FILTER_FIELD = 'FACILITY_TYPE'
        const HOME_CENTER = [38.26438, -85.74330]
        const HOME_ZOOM = 12

        // A distinct, accessible color palette for visualization
        const COLOR_PALETTE = [
            '#E53E3E', // Red
            '#38A169', // Green
            '#3182CE', // Blue
            '#D69E2E', // Yellow/Brown
            '#805AD5', // Purple
            '#DD6B20', // Orange
            '#00A3C4', // Cyan
            '#9F7AEA', // Violet
            '#ED64A6', // Pink
            '#718096', // Gray (use as fallback if more than 10 types)
            '#4A5568', // Dark Gray
        ];

        // Set up the map
        const map = L.map('map', { 
            zoomControl: false 
        });
        map.setView(HOME_CENTER, HOME_ZOOM);

        // Add a tile layer (OpenStreetMap is the default for Leaflet)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 15,
        }).addTo(map);

        /**
         * Generates a custom Leaflet DivIcon (a colored circle) for the marker.
         * @param {string} color The hex color code for the marker.
         * @returns {L.DivIcon} A custom Leaflet icon object.
         */
        function getColoredIcon(color) {
            return L.divIcon({
                className: 'custom-marker',
                // HTML for a small, colored circle
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 2px #000;"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6] // Center the icon over the coordinates
            });
        }
        
        /**
         * Assigns a unique color from the palette to each event type.
         * @param {Array<string>} uniqueTypes Sorted array of unique event types.
         */
        function generateTypeColors(uniqueTypes) {
            typeColors = {};
            uniqueTypes.forEach((type, index) => {
                // Cycle through the COLOR_PALETTE
                typeColors[type] = COLOR_PALETTE[index % COLOR_PALETTE.length];
            });
        }
  
        // Simple function to parse the CSV string into an array of objects
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            // Assuming the first line is the header
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, j) => {
                        row[header] = values[j].trim();
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function createPopupContent(item) {
            let popupContent = `<div class="font-bold text-lg mb-1">${item.NAME}</div>`;
            const combinedAddress = `${item.ADDRESS}<br>${item.CITY}, ${item.ST} ${item.ZIP}`;

            popupContent += `<p class="text-sm mb-2"><strong>Facility Type: </strong>${item.FACILITY_TYPE}</p>`;            
            popupContent += `<p class="text-sm mb-2"><strong>Phone: </strong>${item.PHONE}</p>`;
            popupContent += `<p class="text-sm mb-2"><strong>Address: </strong>${combinedAddress}</p>`;
            popupContent += `<p class="text-sm mb-2"><strong>Administrator: </strong>${item.ADMINISTRATOR}</p>`;
            popupContent += `<p class="text-sm mb-2"><strong>Owner: </strong>${item.OWNER}</p>`;

            return popupContent;
        }

        function plotMarkers(dataToPlot) {
            // 1. Clear existing markers
            if (markerGroup) {
                map.removeLayer(markerGroup);
            }
            
            const markers = [];

            // 2. Create new markers
            dataToPlot.forEach(item => {
                const lat = parseFloat(item[LATITUDE_FIELD]);
                const lon = parseFloat(item[LONGITUDE_FIELD]);

                // Skip if coordinates are invalid
                if (isNaN(lat) || isNaN(lon)) return; 

                // Determine the marker color based on type
                const type = item[FILTER_FIELD];
                const color = typeColors[type] || '#000000'; 
                const icon = getColoredIcon(color);

                const popupContent = createPopupContent(item);

                // Apply the custom icon to the marker
                const marker = L.marker([lat, lon], { icon: icon }).bindPopup(popupContent);
                markers.push(marker);
            });

            // 3. Add new markers to a FeatureGroup and add to map
            markerGroup = new L.FeatureGroup(markers);
            markerGroup.addTo(map);

        }
        /**
         * Checks if a single data point's coordinates fall within the current map view bounds.
         * @param {Object} item The data object with latitude and longitude.
         * @param {L.LatLngBounds} bounds The current Leaflet map bounds.
         * @returns {boolean} True if the point is within bounds, false otherwise.
         */
        function isMarkerInView(item, bounds) {
            const lat = parseFloat(item[LATITUDE_FIELD]);
            const lon = parseFloat(item[LONGITUDE_FIELD]);
            if (isNaN(lat) || isNaN(lon)) return false;
            
            // Check if the coordinate is contained within the bounds
            return bounds.contains(L.latLng(lat, lon));
        }
                
        /**
         * Gets the currently selected types from the checkboxes and calls plotMarkers.
         */
        function applyFilters() {
            const filterContainer = document.getElementById('filter-checkboxes');
            // Select only checked checkboxes to determine which types to display
            const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]:checked');
            
            // Get selected type values
            const selectedTypes = Array.from(checkboxes).map(cb => cb.value);

            // Filter the global data
            const filteredData = allData.filter(item => selectedTypes.includes(item[FILTER_FIELD]));
            
            // Update global variable for export function
            currentFilteredData = filteredData; 

            plotMarkers(filteredData);
        }

        /**
         * Finds all unique values in the FILTER_FIELD column.
         * @param {Array<Object>} data The entire dataset.
         * @returns {Array<string>} Array of unique types.
         */
        function getUniqueTypes(data) {
            const types = new Set();
            data.forEach(item => {
                if (item[FILTER_FIELD] && item[FILTER_FIELD].trim() !== '') {
                    types.add(item[FILTER_FIELD].trim());
                }
            });
            return Array.from(types).sort();
        }

        /**
         * Converts the currently filtered data into a CSV string and triggers a download.
         */
        function exportFilteredData() {
            if (currentFilteredData.length === 0) {
                console.warn("No data to export.");
                return;
            }

            // 1. Get the currently visible boundaries of the map
            const bounds = map.getBounds();
            
            // 2. Filter data by visible bounds
            // Only export data that passed the type filter AND is currently visible
            const dataToExport = currentFilteredData.filter(item => isMarkerInView(item, bounds));

            if (dataToExport.length === 0) {
                console.warn("No visible data to export based on current filters and map view.");
                return;
            }

            // 3. Get Headers (using keys from the first object, which assumes consistency)
            const headers = Object.keys(dataToExport[0]);
            
            // 4. Build the CSV rows
            const csvRows = [];
            // Add the header row
            csvRows.push(headers.join(','));

            // Add data rows
            for (const row of dataToExport) {
                const values = headers.map(header => {
                    // Escape double quotes and enclose in quotes
                    const value = row[header] !== undefined ? String(row[header]) : '';
                    // Basic CSV sanitization: replace quotes with double quotes and wrap in quotes
                    const escaped = value.replace(/"/g, '""'); 
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            // Combine all rows into a single string
            const csvString = csvRows.join('\n');

            // 4. Trigger download using a Blob and temporary link
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "filtered_facility_data.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Clean up the URL object
            }
        }


        /**
         * Generates the filter UI with checkboxes for each unique type.
         * @param {Array<string>} uniqueTypes The array of unique types.
         */
        function renderFilterUI(uniqueTypes) {
            const container = document.getElementById('filter-checkboxes');
            container.innerHTML = ''; // Clear previous content

            uniqueTypes.forEach(type => {
                const id = `filter-${type.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                const label = document.createElement('label');
                label.htmlFor = id;
                const color = typeColors[type] || '#000000';
                label.className = 'filter-label';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = id;
                input.value = type;
                input.checked = true; // Select all by default
                input.className = 'rounded text-blue-500 focus:ring-blue-500';
                
                // Add the event listener to trigger filtering on change
                input.addEventListener('change', applyFilters);
                
                // Add a small colored swatch next to the label text (The Symbol)
                const swatch = document.createElement('span');
                swatch.className = 'w-3 h-3 rounded-full shadow-sm flex-shrink-0';
                swatch.style.cssText = `background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0;`;
                
                const span = document.createElement('span');
                span.textContent = type;

                label.appendChild(input);
                label.appendChild(swatch);
                label.appendChild(span);
                container.appendChild(label);
            });
            
            // 2. Set up Select/Clear All button logic
            const selectAllButton = document.getElementById('select-all-button');
            const clearAllButton = document.getElementById('clear-all-button');
            
            const toggleAllCheckboxes = (checkedState) => {
                // Select all current checkboxes in the container
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = checkedState);
                applyFilters(); // Re-apply filters after state change
            };

            selectAllButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleAllCheckboxes(true);
            });

            clearAllButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleAllCheckboxes(false);
            });
            
            // 3. Set up Done button logic
            const doneButton = document.getElementById('done-button');
            doneButton.addEventListener('click', (event) => {
                event.stopPropagation();
                filterPanel.classList.add('hidden'); // Close the panel
            });

            // 4. Set up Panel visibility toggle logic (Existing)
            const filterButton = document.getElementById('filter-button');
            const filterPanel = document.getElementById('filter-panel');
            
            filterButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                filterPanel.classList.toggle('hidden');
            });

            // Close filter panel if clicking outside the control container
            document.addEventListener('click', (event) => {
                const filterControlContainer = document.getElementById('filter-control-container');
                if (!filterControlContainer.contains(event.target)) {
                    filterPanel.classList.add('hidden');
                }
            });
            
             // Stop clicks inside the panel from closing it
            filterPanel.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        }

        // Sets up the event listener for the export button.
        function setupGlobalListeners() {
            const exportButton = document.getElementById('export-csv-button');
            exportButton.addEventListener('click', (event) => {
                event.stopPropagation();
                 exportFilteredData();
            });

            const homeButton = document.getElementById('home-button');
            homeButton.addEventListener('click', (event) => {
                event.stopPropagation();
                map.flyTo(HOME_CENTER, HOME_ZOOM, {
                    animate: true,
                    duration: 0.5
                }); 
            });


            const locateButton = document.getElementById('locate-button');
            let locationMarker = null; // To store the user's location marker
            
            locateButton.addEventListener('click', (event) => {
                event.stopPropagation();
                
                // Clear previous marker if it exists
                if (locationMarker) {
                    map.removeLayer(locationMarker);
                    locationMarker = null;
                }

                // Use Leaflet's built-in geolocation
                map.locate({ 
                    setView: true, // Automatically center the map on the location
                    maxZoom: 15,  // Zoom level to set after finding location
                    enableHighAccuracy: true 
                });
            });
            // Handle location success
            map.on('locationfound', (e) => {

                // Remove old accuracy circle if present
                map.eachLayer(layer => {
                    if (layer instanceof L.Circle) {
                        map.removeLayer(layer);
                    }
                });
                
                const radius = e.accuracy / 2;
                
                // Create a custom pulsing icon for the location marker
                const locationIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: `<div style="background-color: #2563eb; width: 14px; height: 14px; border-radius: 50%; border: 3px solid #ffffff; box-shadow: 0 0 5px rgba(37, 99, 235, 0.7); animation: pulse 1.5s infinite;"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                // Add the new location marker
                locationMarker = L.marker(e.latlng, { icon: locationIcon })
                    .addTo(map)
            
                // Add a circle showing accuracy
                L.circle(e.latlng, radius, {
                    color: '#2563eb', // Blue border
                    fillColor: '#60a5fa', // Lighter blue fill
                    fillOpacity: 0.2,
                    weight: 1
                }).addTo(map);
            });

            // Handle location error
            map.on('locationerror', (e) => {
                console.error(e.message);
                
                // Display error message using a temporary div overlay
                const mapDiv = document.getElementById('map');
                let messageDiv = document.getElementById('location-error-message');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'location-error-message';
                    mapDiv.appendChild(messageDiv);
                }
                
                messageDiv.style.cssText = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; padding: 1rem; background-color: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: opacity 0.3s ease-in-out; opacity: 1;";
                messageDiv.innerHTML = `<strong>Location Error:</strong> ${e.message}. Please ensure location services are enabled.`;
                
                // Remove the message after 4 seconds
                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300); // Wait for fade out
                }, 4000);
            });
        }


        // Fetches and plots the data initially
        async function loadDataAndPlot() {
            try {
                // 1. Fetch and Parse the data
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                // Store all data globally
                allData = parseCSV(csvText);
                
                // 2. Find unique types, generate colors, and render UI/Legend
                const uniqueTypes = getUniqueTypes(allData);
                generateTypeColors(uniqueTypes);
                renderFilterUI(uniqueTypes);
                setupGlobalListeners();
                
                // 3. Initial Plot: show all data (since all checkboxes are checked by default)
                applyFilters(); 
                
            } catch (error) {
                console.error("Error loading or processing CSV data:", error);
                // Display error message on the map itself
                const errorElement = document.createElement("div");
                errorElement.style.cssText = "padding: 1rem; background-color: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; border-radius: 0.5rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.1);";
                errorElement.innerHTML = `<strong>Data Error:</strong> Could not load CSV. Check the console for details.`;
                document.getElementById("map").appendChild(errorElement);
            }
        }

        // Start the process
        loadDataAndPlot();

    </script>
</body>

</html>
